-- get average arrival delay by plane itself
CREATE TABLE delays_by_tailnum(
    tailNum STRING,
    avg_delay INT);

insert into delays_by_tailnum
select tailNum, avg(arrDelay)
from flight_data
group by tailNum;

-- map the tailNum to a year, and get average for the whole year
CREATE TABLE delays_by_year(
    made_year INT,
    avg_delay INT);

-- grab the data, group it, and sort by avg_delay
select year as yr, avg(avg_delay) as delay
from delays_by_tailnum D inner join plane_metadata P
on D.tailNum = P.tailNum
group by year
order by delay desc;

""" Results
1965	12.0
2006	11.811881188118813
1997	10.83739837398374
1977	10.25
1976	10.125
1990	10.06015037593985
NULL	9.913555992141454
1991	9.55944055944056
1975	9.555555555555555
1994	9.297029702970297
1979	9.181818181818182
1974	9.0
1978	9.0
1992	8.924242424242424
2005	8.685534591194969
1999	8.536842105263158
2002	8.458620689655172
1986	8.435897435897436
1988	8.422222222222222
1993	8.35632183908046
2004	8.218579234972678
1996	8.19626168224299
1987	8.172131147540984
1989	8.158415841584159
1998	8.150627615062762
2000	8.081272084805654
2007	8.0
1959	8.0
1973	8.0
1980	8.0
1984	7.961538461538462
1985	7.924050632911392
2003	7.837398373983739
1995	7.777777777777778
1982	7.666666666666667
2001	7.634285714285714
1968	7.583333333333333
1970	7.5
1969	7.5
1963	7.5
1983	7.111111111111111
1964	7.0
1962	7.0
1966	7.0
1967	6.8
1956	6.0
1971	5.0
1972	5.0
0	4.0
1957	2.0
"""
